-- ============================================================
-- SISTEMA DE GESTIÓN ACADÉMICA - BASE DE DATOS COMPLETA
-- ============================================================

-- ============================================================
-- ENUMERACIONES
-- ============================================================
CREATE TYPE tipo_documento AS ENUM ('cedula_de_ciudadania', 'tarjeta_identidad', 'cedula_extranjeria', 'pasaporte');
CREATE TYPE estado_asistencia AS ENUM ('presente', 'ausente', 'excusa', 'tardanza');
CREATE TYPE tipo_rol AS ENUM ('administrador', 'profesor', 'estudiante');
CREATE TYPE estado_est AS ENUM ('activo', 'inactivo', 'retirado', 'graduado', 'suspendido');
CREATE TYPE resultado_competencia AS ENUM ('aprobado', 'reprobado', 'pendiente');
CREATE TYPE tipo_expediente AS ENUM ('certificado_estudios', 'hoja_vida', 'documento_identidad', 'certificado_medico', 'carta_presentacion', 'otro');
CREATE TYPE tipo_notificacion AS ENUM ('general', 'alerta', 'recordatorio', 'evaluacion', 'actividad', 'calificacion');

-- ============================================================
-- USUARIOS Y AUTENTICACIÓN
-- ============================================================
CREATE TABLE Tb_rol (
    id_rol SERIAL PRIMARY KEY,
    nombre_rol tipo_rol UNIQUE NOT NULL,
    descripcion TEXT,
    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE Tb_usuario (
    id_usuario SERIAL PRIMARY KEY,
    email VARCHAR(100) NOT NULL UNIQUE, -- Email único
    tipo_documento tipo_documento NOT NULL,
    no_documento VARCHAR(50) NOT NULL UNIQUE, -- Soporta letras y números
    password VARCHAR(255) NOT NULL,
    activo BOOLEAN DEFAULT TRUE,
    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    ultima_sesion TIMESTAMP,
    intentos_fallidos INT DEFAULT 0, -- Para seguridad
    bloqueado_hasta TIMESTAMP,
    id_rol INT NOT NULL,
    FOREIGN KEY (id_rol) REFERENCES Tb_rol(id_rol),
    CONSTRAINT check_email_format CHECK (email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$')
);

CREATE TABLE Tb_datos_personales (
    id_datos_personales SERIAL PRIMARY KEY,
    nombre VARCHAR(100) NOT NULL,
    apellido VARCHAR(100) NOT NULL,
    fecha_nacimiento DATE NOT NULL,
    telefono VARCHAR(20),
    direccion VARCHAR(200),
    ciudad VARCHAR(100),
    departamento VARCHAR(100),
    codigo_postal VARCHAR(20),
    genero VARCHAR(20),
    foto_perfil VARCHAR(500),
    fecha_registro TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    id_usuario INT UNIQUE NOT NULL,
    FOREIGN KEY (id_usuario) REFERENCES Tb_usuario(id_usuario) ON DELETE CASCADE,
    CONSTRAINT check_edad_minima CHECK (fecha_nacimiento <= CURRENT_DATE - INTERVAL '14 years')
);

-- ============================================================
-- CURSOS
-- ============================================================
CREATE TABLE Tb_curso (
    id_curso SERIAL PRIMARY KEY,
    ficha VARCHAR(50) NOT NULL UNIQUE, -- Código único del curso
    nombre_curso VARCHAR(100) NOT NULL,
    descripcion TEXT,
    creditos INT,
    fecha_inicio DATE,
    fecha_fin DATE,
    cupo_maximo INT,
    activo BOOLEAN DEFAULT TRUE,
    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    id_profesor INT NOT NULL,
    FOREIGN KEY (id_profesor) REFERENCES Tb_usuario(id_usuario),
    CONSTRAINT check_fechas_curso CHECK (fecha_fin IS NULL OR fecha_fin > fecha_inicio)
);

CREATE TABLE Tb_estudiante_curso (
    id_estudiante_curso SERIAL PRIMARY KEY,
    id_usuario INT NOT NULL,
    id_curso INT NOT NULL,
    fecha_inscripcion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    estado VARCHAR(20) DEFAULT 'inscrito', -- inscrito, cursando, aprobado, reprobado, retirado
    nota_final NUMERIC(5,2),
    fecha_retiro DATE,
    observaciones TEXT,
    UNIQUE (id_usuario, id_curso),
    FOREIGN KEY (id_usuario) REFERENCES Tb_usuario(id_usuario) ON DELETE CASCADE,
    FOREIGN KEY (id_curso) REFERENCES Tb_curso(id_curso) ON DELETE CASCADE
);

-- ============================================================
-- HORARIOS Y SALONES
-- ============================================================
CREATE TABLE Tb_salon (
    id_salon SERIAL PRIMARY KEY,
    codigo VARCHAR(20) UNIQUE NOT NULL,
    nombre VARCHAR(100) NOT NULL,
    capacidad INT NOT NULL,
    tipo VARCHAR(50), -- aula, laboratorio, auditorio
    edificio VARCHAR(50),
    piso INT,
    tiene_proyector BOOLEAN DEFAULT FALSE,
    tiene_computadores BOOLEAN DEFAULT FALSE,
    observaciones TEXT,
    activo BOOLEAN DEFAULT TRUE
);

CREATE TABLE Tb_horario_clase (
    id_horario SERIAL PRIMARY KEY,
    dia_semana INT NOT NULL, -- 1=Lunes ... 7=Domingo
    hora_inicio TIME NOT NULL,
    hora_fin TIME NOT NULL,
    id_curso INT NOT NULL,
    id_salon INT,
    fecha_inicio_vigencia DATE DEFAULT CURRENT_DATE,
    fecha_fin_vigencia DATE,
    FOREIGN KEY (id_curso) REFERENCES Tb_curso(id_curso) ON DELETE CASCADE,
    FOREIGN KEY (id_salon) REFERENCES Tb_salon(id_salon),
    CONSTRAINT check_dia_valido CHECK (dia_semana BETWEEN 1 AND 7),
    CONSTRAINT check_horas_validas CHECK (hora_fin > hora_inicio)
);

-- ============================================================
-- CONTACTOS DE EMERGENCIA
-- ============================================================
CREATE TABLE Tb_contacto_emergencia (
    id_contacto_emergencia SERIAL PRIMARY KEY,
    nombre VARCHAR(100) NOT NULL,
    apellido VARCHAR(100) NOT NULL,
    telefono VARCHAR(20) NOT NULL,
    telefono_alternativo VARCHAR(20),
    parentesco VARCHAR(50) NOT NULL,
    direccion VARCHAR(150),
    correo VARCHAR(100),
    observaciones TEXT,
    es_principal BOOLEAN DEFAULT FALSE, -- Contacto principal
    id_usuario INT NOT NULL,
    FOREIGN KEY (id_usuario) REFERENCES Tb_usuario(id_usuario) ON DELETE CASCADE
);

-- ============================================================
-- ASISTENCIAS
-- ============================================================
CREATE TABLE Tb_asistencia (
    id_asistencia SERIAL PRIMARY KEY,
    fecha DATE NOT NULL,
    hora TIME DEFAULT CURRENT_TIME,
    estado estado_asistencia NOT NULL,
    observaciones TEXT,
    minutos_tarde INT,
    justificacion TEXT,
    archivo_justificacion VARCHAR(500),
    fecha_registro TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    id_estudiante_curso INT NOT NULL,
    id_registrado_por INT,
    FOREIGN KEY (id_estudiante_curso) REFERENCES Tb_estudiante_curso(id_estudiante_curso) ON DELETE CASCADE,
    FOREIGN KEY (id_registrado_por) REFERENCES Tb_usuario(id_usuario),
    UNIQUE (fecha, id_estudiante_curso) -- Evita duplicados
);

CREATE INDEX idx_asistencia_fecha ON Tb_asistencia(fecha);
CREATE INDEX idx_asistencia_estudiante ON Tb_asistencia(id_estudiante_curso);
CREATE INDEX idx_asistencia_estado ON Tb_asistencia(estado);

-- ============================================================
-- EXPEDIENTES Y ESTADO DE ESTUDIANTES
-- ============================================================
CREATE TABLE Tb_expediente_estudiante (
    id_expediente_estudiante SERIAL PRIMARY KEY,
    tipo_documento tipo_expediente NOT NULL,
    nombre_archivo VARCHAR(255) NOT NULL,
    ruta_documento VARCHAR(500) NOT NULL,
    tamanio_bytes BIGINT,
    mime_type VARCHAR(100),
    descripcion TEXT,
    fecha_carga TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    fecha_documento DATE,
    id_usuario INT NOT NULL,
    id_subido_por INT,
    FOREIGN KEY (id_usuario) REFERENCES Tb_usuario(id_usuario) ON DELETE CASCADE,
    FOREIGN KEY (id_subido_por) REFERENCES Tb_usuario(id_usuario)
);

CREATE TABLE Tb_estado_estudiante (
    id_estado_estudiante SERIAL PRIMARY KEY,
    estado estado_est NOT NULL,
    fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    observaciones TEXT,
    motivo VARCHAR(200),
    id_usuario INT NOT NULL,
    id_actualizado_por INT,
    FOREIGN KEY (id_usuario) REFERENCES Tb_usuario(id_usuario) ON DELETE CASCADE,
    FOREIGN KEY (id_actualizado_por) REFERENCES Tb_usuario(id_usuario)
);

CREATE INDEX idx_estado_estudiante_fecha ON Tb_estado_estudiante(id_usuario, fecha_actualizacion DESC);

-- ============================================================
-- COMPETENCIAS
-- ============================================================
CREATE TABLE Tb_competencia (
    id_competencia SERIAL PRIMARY KEY,
    codigo VARCHAR(20) UNIQUE, -- Código único de competencia
    nombre VARCHAR(200) NOT NULL,
    descripcion TEXT,
    nivel VARCHAR(50), -- Básico, Intermedio, Avanzado
    activa BOOLEAN DEFAULT TRUE,
    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    id_profesor INT NOT NULL,
    FOREIGN KEY (id_profesor) REFERENCES Tb_usuario(id_usuario)
);

CREATE TABLE Tb_competencia_curso (
    id_curso INT NOT NULL,
    id_competencia INT NOT NULL,
    peso_porcentaje NUMERIC(5,2), -- Porcentaje en el curso
    fecha_asignacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (id_curso, id_competencia),
    FOREIGN KEY (id_curso) REFERENCES Tb_curso(id_curso) ON DELETE CASCADE,
    FOREIGN KEY (id_competencia) REFERENCES Tb_competencia(id_competencia) ON DELETE CASCADE,
    CONSTRAINT check_peso_valido CHECK (peso_porcentaje >= 0 AND peso_porcentaje <= 100)
);

-- ============================================================
-- EVALUACIONES
-- ============================================================
CREATE TABLE Tb_evaluacion (
    id_evaluacion SERIAL PRIMARY KEY,
    titulo VARCHAR(200) NOT NULL,
    descripcion TEXT,
    tipo_evaluacion VARCHAR(50), -- quiz, examen, parcial, final
    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    fecha_disponible TIMESTAMP,
    fecha_limite TIMESTAMP,
    duracion_minutos INT,
    puntaje_total NUMERIC(5,2),
    intentos_permitidos INT DEFAULT 1,
    mostrar_resultados BOOLEAN DEFAULT TRUE,
    activa BOOLEAN DEFAULT TRUE,
    id_curso INT NOT NULL,
    id_competencia INT,
    FOREIGN KEY (id_curso) REFERENCES Tb_curso(id_curso) ON DELETE CASCADE,
    FOREIGN KEY (id_competencia) REFERENCES Tb_competencia(id_competencia),
    CONSTRAINT check_fechas_evaluacion CHECK (fecha_limite IS NULL OR fecha_disponible IS NULL OR fecha_limite > fecha_disponible)
);

CREATE TABLE Tb_preguntas (
    id_pregunta SERIAL PRIMARY KEY,
    pregunta TEXT NOT NULL,
    tipo_pregunta VARCHAR(50) DEFAULT 'multiple', -- multiple, verdadero_falso, abierta
    puntaje NUMERIC(5,2) DEFAULT 1.00,
    orden INT,
    explicacion TEXT, -- Retroalimentación
    id_evaluacion INT NOT NULL,
    FOREIGN KEY (id_evaluacion) REFERENCES Tb_evaluacion(id_evaluacion) ON DELETE CASCADE
);

CREATE TABLE Tb_opciones_respuesta (
    id_opcion SERIAL PRIMARY KEY,
    opcion TEXT NOT NULL,
    es_correcta BOOLEAN DEFAULT FALSE,
    orden INT,
    retroalimentacion TEXT,
    id_pregunta INT NOT NULL,
    FOREIGN KEY (id_pregunta) REFERENCES Tb_preguntas(id_pregunta) ON DELETE CASCADE
);

-- ============================================================
-- RESPUESTAS DE ESTUDIANTES
-- ============================================================
CREATE TABLE Tb_respuesta_estudiante (
    id_respuesta SERIAL PRIMARY KEY,
    id_evaluacion INT NOT NULL,
    id_pregunta INT NOT NULL,
    id_estudiante INT NOT NULL,
    id_opcion_seleccionada INT, -- Para preguntas de selección
    respuesta_texto TEXT, -- Para preguntas abiertas
    es_correcta BOOLEAN,
    puntaje_obtenido NUMERIC(5,2),
    fecha_respuesta TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    tiempo_respuesta_segundos INT,
    FOREIGN KEY (id_evaluacion) REFERENCES Tb_evaluacion(id_evaluacion) ON DELETE CASCADE,
    FOREIGN KEY (id_pregunta) REFERENCES Tb_preguntas(id_pregunta) ON DELETE CASCADE,
    FOREIGN KEY (id_estudiante) REFERENCES Tb_usuario(id_usuario) ON DELETE CASCADE,
    FOREIGN KEY (id_opcion_seleccionada) REFERENCES Tb_opciones_respuesta(id_opcion),
    UNIQUE (id_evaluacion, id_pregunta, id_estudiante)
);

CREATE TABLE Tb_intento_evaluacion (
    id_intento SERIAL PRIMARY KEY,
    id_evaluacion INT NOT NULL,
    id_estudiante INT NOT NULL,
    numero_intento INT NOT NULL,
    fecha_inicio TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    fecha_finalizacion TIMESTAMP,
    puntaje_obtenido NUMERIC(5,2),
    calificacion NUMERIC(5,2),
    completado BOOLEAN DEFAULT FALSE,
    tiempo_total_segundos INT,
    FOREIGN KEY (id_evaluacion) REFERENCES Tb_evaluacion(id_evaluacion) ON DELETE CASCADE,
    FOREIGN KEY (id_estudiante) REFERENCES Tb_usuario(id_usuario) ON DELETE CASCADE,
    UNIQUE (id_evaluacion, id_estudiante, numero_intento)
);

-- ============================================================
-- CALIFICACIONES
-- ============================================================
CREATE TABLE Tb_calificacion (
    id_calificacion SERIAL PRIMARY KEY,
    nota NUMERIC(5,2) NOT NULL, -- Nota numérica (no ENUM)
    porcentaje NUMERIC(5,2),
    fecha_calificacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    observaciones TEXT,
    retroalimentacion TEXT,
    id_evaluacion INT NOT NULL,
    id_estudiante INT NOT NULL,
    id_profesor INT NOT NULL,
    FOREIGN KEY (id_evaluacion) REFERENCES Tb_evaluacion(id_evaluacion) ON DELETE CASCADE,
    FOREIGN KEY (id_estudiante) REFERENCES Tb_usuario(id_usuario) ON DELETE CASCADE,
    FOREIGN KEY (id_profesor) REFERENCES Tb_usuario(id_usuario),
    UNIQUE (id_evaluacion, id_estudiante),
    CONSTRAINT check_nota_valida CHECK (nota >= 0 AND nota <= 100)
);

CREATE TABLE Tb_resultado_competencia (
    id_resultado SERIAL PRIMARY KEY,
    fecha_evaluacion DATE DEFAULT CURRENT_DATE,
    estado resultado_competencia NOT NULL,
    nota_final NUMERIC(5,2),
    porcentaje NUMERIC(5,2),
    observaciones TEXT,
    id_competencia INT NOT NULL,
    id_usuario INT NOT NULL,
    id_profesor INT NOT NULL,
    FOREIGN KEY (id_competencia) REFERENCES Tb_competencia(id_competencia),
    FOREIGN KEY (id_usuario) REFERENCES Tb_usuario(id_usuario) ON DELETE CASCADE,
    FOREIGN KEY (id_profesor) REFERENCES Tb_usuario(id_usuario),
    UNIQUE (id_competencia, id_usuario)
);

-- ============================================================
-- ACTIVIDADES
-- ============================================================
CREATE TABLE Tb_actividad (
    id_actividad SERIAL PRIMARY KEY,
    titulo VARCHAR(200) NOT NULL,
    descripcion TEXT,
    instrucciones TEXT,
    tipo_actividad VARCHAR(50), -- tarea, proyecto, lectura
    fecha_publicacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    fecha_limite TIMESTAMP,
    puntaje_maximo NUMERIC(5,2),
    permite_entrega_tardia BOOLEAN DEFAULT FALSE,
    penalizacion_tardia NUMERIC(5,2), -- Puntos a restar
    ruta_archivo VARCHAR(500),
    activa BOOLEAN DEFAULT TRUE,
    id_competencia INT NOT NULL,
    id_curso INT NOT NULL,
    id_profesor INT NOT NULL,
    FOREIGN KEY (id_competencia) REFERENCES Tb_competencia(id_competencia),
    FOREIGN KEY (id_curso) REFERENCES Tb_curso(id_curso) ON DELETE CASCADE,
    FOREIGN KEY (id_profesor) REFERENCES Tb_usuario(id_usuario)
);

CREATE INDEX idx_actividad_curso ON Tb_actividad(id_curso);
CREATE INDEX idx_actividad_fecha_limite ON Tb_actividad(fecha_limite);
CREATE INDEX idx_actividad_profesor ON Tb_actividad(id_profesor);

-- ============================================================
-- ENTREGAS DE ACTIVIDADES
-- ============================================================
CREATE TABLE Tb_entrega_actividad (
    id_entrega SERIAL PRIMARY KEY,
    fecha_entrega TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    ruta_archivo VARCHAR(500) NOT NULL,
    nombre_archivo VARCHAR(255),
    tamanio_bytes BIGINT,
    comentario_estudiante TEXT,
    calificacion NUMERIC(5,2), -- Nota numérica (no ENUM)
    retroalimentacion TEXT,
    fecha_calificacion TIMESTAMP,
    entrega_tardia BOOLEAN DEFAULT FALSE,
    id_actividad INT NOT NULL,
    id_estudiante INT NOT NULL,
    id_profesor_calificador INT,
    FOREIGN KEY (id_actividad) REFERENCES Tb_actividad(id_actividad) ON DELETE CASCADE,
    FOREIGN KEY (id_estudiante) REFERENCES Tb_usuario(id_usuario) ON DELETE CASCADE,
    FOREIGN KEY (id_profesor_calificador) REFERENCES Tb_usuario(id_usuario),
    UNIQUE (id_actividad, id_estudiante)
);

CREATE INDEX idx_entrega_actividad ON Tb_entrega_actividad(id_actividad);
CREATE INDEX idx_entrega_estudiante ON Tb_entrega_actividad(id_estudiante);
CREATE INDEX idx_entrega_calificacion ON Tb_entrega_actividad(id_profesor_calificador);

-- ============================================================
-- MATERIALES DIDÁCTICOS
-- ============================================================
CREATE TABLE Tb_material_curso (
    id_material SERIAL PRIMARY KEY,
    titulo VARCHAR(200) NOT NULL,
    descripcion TEXT,
    tipo_material VARCHAR(50), -- pdf, video, enlace, presentacion
    ruta_archivo VARCHAR(500),
    url_externa VARCHAR(500), -- Para enlaces (YouTube, etc.)
    tamanio_bytes BIGINT,
    orden INT,
    visible BOOLEAN DEFAULT TRUE,
    fecha_publicacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    descargas INT DEFAULT 0,
    id_curso INT NOT NULL,
    id_competencia INT,
    id_profesor INT NOT NULL,
    FOREIGN KEY (id_curso) REFERENCES Tb_curso(id_curso) ON DELETE CASCADE,
    FOREIGN KEY (id_competencia) REFERENCES Tb_competencia(id_competencia),
    FOREIGN KEY (id_profesor) REFERENCES Tb_usuario(id_usuario)
);

-- ============================================================
-- ANUNCIOS DEL CURSO
-- ============================================================
CREATE TABLE Tb_anuncio_curso (
    id_anuncio SERIAL PRIMARY KEY,
    titulo VARCHAR(200) NOT NULL,
    contenido TEXT NOT NULL,
    prioridad VARCHAR(20) DEFAULT 'normal', -- baja, normal, alta, urgente
    fecha_publicacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    fecha_expiracion TIMESTAMP,
    fijado BOOLEAN DEFAULT FALSE, -- Mantener al inicio
    id_curso INT NOT NULL,
    id_profesor INT NOT NULL,
    FOREIGN KEY (id_curso) REFERENCES Tb_curso(id_curso) ON DELETE CASCADE,
    FOREIGN KEY (id_profesor) REFERENCES Tb_usuario(id_usuario)
);

-- ============================================================
-- NOTIFICACIONES
-- ============================================================
CREATE TABLE Tb_notificaciones (
    id_notificacion SERIAL PRIMARY KEY,
    titulo VARCHAR(200) NOT NULL,
    mensaje TEXT NOT NULL,
    tipo tipo_notificacion DEFAULT 'general',
    prioridad VARCHAR(20) DEFAULT 'normal',
    fecha_envio TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    fecha_lectura TIMESTAMP,
    leido BOOLEAN DEFAULT FALSE,
    entregado BOOLEAN DEFAULT FALSE,
    url_accion VARCHAR(500), -- URL al hacer clic
    id_usuario INT NOT NULL,
    id_remitente INT,
    FOREIGN KEY (id_usuario) REFERENCES Tb_usuario(id_usuario) ON DELETE CASCADE,
    FOREIGN KEY (id_remitente) REFERENCES Tb_usuario(id_usuario)
);

CREATE INDEX idx_notificaciones_usuario_leido ON Tb_notificaciones(id_usuario, leido);
CREATE INDEX idx_notificaciones_fecha ON Tb_notificaciones(fecha_envio DESC);

-- ============================================================
-- MENSAJERÍA INTERNA
-- ============================================================
CREATE TABLE Tb_mensaje (
    id_mensaje SERIAL PRIMARY KEY,
    asunto VARCHAR(200),
    contenido TEXT NOT NULL,
    fecha_envio TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    leido BOOLEAN DEFAULT FALSE,
    fecha_lectura TIMESTAMP,
    eliminado_remitente BOOLEAN DEFAULT FALSE,
    eliminado_destinatario BOOLEAN DEFAULT FALSE,
    id_remitente INT NOT NULL,
    id_destinatario INT NOT NULL,
    id_mensaje_padre INT, -- Para respuestas
    FOREIGN KEY (id_remitente) REFERENCES Tb_usuario(id_usuario) ON DELETE CASCADE,
    FOREIGN KEY (id_destinatario) REFERENCES Tb_usuario(id_usuario) ON DELETE CASCADE,
    FOREIGN KEY (id_mensaje_padre) REFERENCES Tb_mensaje(id_mensaje)
);

CREATE INDEX idx_mensaje_destinatario ON Tb_mensaje(id_destinatario, leido);
CREATE INDEX idx_mensaje_remitente ON Tb_mensaje(id_remitente);

-- ============================================================
-- CALENDARIO ACADÉMICO
-- ============================================================
CREATE TABLE Tb_evento_academico (
    id_evento SERIAL PRIMARY KEY,
    titulo VARCHAR(200) NOT NULL,
    descripcion TEXT,
    tipo_evento VARCHAR(50), -- festivo, evaluacion, reunion, ceremonia
    fecha_inicio TIMESTAMP NOT NULL,
    fecha_fin TIMESTAMP,
    todo_el_dia BOOLEAN DEFAULT FALSE,
    ubicacion VARCHAR(200),
    id_curso INT, -- NULL si es evento general
    id_creado_por INT NOT NULL,
    FOREIGN KEY (id_curso) REFERENCES Tb_curso(id_curso) ON DELETE CASCADE,
    FOREIGN KEY (id_creado_por) REFERENCES Tb_usuario(id_usuario)
);

CREATE INDEX idx_evento_fecha ON Tb_evento_academico(fecha_inicio);

-- ============================================================
-- LOG DE ACTIVIDADES
-- ============================================================
CREATE TABLE Tb_log_actividades (
    id_log SERIAL PRIMARY KEY,
    actividad VARCHAR(255) NOT NULL,
    detalle TEXT,
    ip_address VARCHAR(45), -- IPv4 e IPv6
    fecha TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    id_usuario INT,
    FOREIGN KEY (id_usuario) REFERENCES Tb_usuario(id_usuario) ON DELETE SET NULL
);

CREATE INDEX idx_log_fecha ON Tb_log_actividades(fecha DESC);
CREATE INDEX idx_log_usuario ON Tb_log_actividades(id_usuario);

-- ============================================================
-- ÍNDICES ADICIONALES PARA OPTIMIZACIÓN
-- ============================================================
CREATE INDEX idx_usuario_rol ON Tb_usuario(id_rol);
CREATE INDEX idx_usuario_email ON Tb_usuario(email);
CREATE INDEX idx_curso_profesor ON Tb_curso(id_profesor);
CREATE INDEX idx_curso_activo ON Tb_curso(activo);
CREATE INDEX idx_competencia_profesor ON Tb_competencia(id_profesor);
CREATE INDEX idx_estudiante_curso_usuario ON Tb_estudiante_curso(id_usuario);
CREATE INDEX idx_estudiante_curso_curso ON Tb_estudiante_curso(id_curso);

-- ============================================================
-- DATOS INICIALES
-- ============================================================
INSERT INTO Tb_rol (nombre_rol, descripcion) VALUES 
    ('administrador', 'Acceso total al sistema'),
    ('profesor', 'Gestiona cursos y evaluaciones'),
    ('estudiante', 'Accede a cursos y actividades');

-- ============================================================
-- VISTAS ÚTILES
-- ============================================================

-- Vista: Información completa de usuarios
CREATE VIEW v_usuarios_completos AS
SELECT 
    u.id_usuario,
    u.email,
    u.tipo_documento,
    u.no_documento,
    u.activo,
    r.nombre_rol,
    dp.nombre,
    dp.apellido,
    dp.fecha_nacimiento,
    dp.telefono,
    dp.ciudad,
    dp.genero,
    dp.foto_perfil
FROM Tb_usuario u
JOIN Tb_rol r ON u.id_rol = r.id_rol
LEFT JOIN Tb_datos_personales dp ON u.id_usuario = dp.id_usuario;

-- Vista: Reporte de asistencias
CREATE VIEW v_reporte_asistencias AS
SELECT 
    c.ficha,
    c.nombre_curso,
    dp.nombre,
    dp.apellido,
    u.no_documento,
    a.fecha,
    a.estado,
    a.minutos_tarde,
    a.observaciones
FROM Tb_asistencia a
JOIN Tb_estudiante_curso ec ON a.id_estudiante_curso = ec.id_estudiante_curso
JOIN Tb_curso c ON ec.id_curso = c.id_curso
JOIN Tb_usuario u ON ec.id_usuario = u.id_usuario
JOIN Tb_datos_personales dp ON u.id_usuario = dp.id_usuario;

-- Vista: Calificaciones de estudiantes
CREATE VIEW v_calificaciones_estudiante AS
SELECT 
    dp.nombre,
    dp.apellido,
    c.nombre_curso,
    e.titulo AS evaluacion,
    cal.nota,
    cal.fecha_calificacion,
    prof.nombre AS profesor_nombre,
    prof.apellido AS profesor_apellido
FROM Tb_calificacion cal
JOIN Tb_evaluacion e ON cal.id_evaluacion = e.id_evaluacion
JOIN Tb_curso c ON e.id_curso = c.id_curso
JOIN Tb_usuario u ON cal.id_estudiante = u.id_usuario
JOIN Tb_datos_personales dp ON u.id_usuario = dp.id_usuario
JOIN Tb_usuario up ON cal.id_profesor = up.id_usuario
JOIN Tb_datos_personales prof ON up.id_usuario = prof.id_usuario;

-- ============================================================
-- FUNCIONES ÚTILES
-- ============================================================

-- Función: Calcular porcentaje de asistencia
CREATE OR REPLACE FUNCTION calcular_porcentaje_asistencia(
    p_id_estudiante_curso INT,
    p_fecha_inicio DATE DEFAULT NULL,
    p_fecha_fin DATE DEFAULT NULL
) RETURNS NUMERIC AS $$
DECLARE
    total_clases INT;
    clases_asistidas INT;
BEGIN
    SELECT COUNT(*) INTO total_clases
    FROM Tb_asistencia
    WHERE id_estudiante_curso = p_id_estudiante_curso
        AND (p_fecha_inicio IS NULL OR fecha >= p_fecha_inicio)
        AND (p_fecha_fin IS NULL OR fecha <= p_fecha_fin);
    
    SELECT COUNT(*) INTO clases_asistidas
    FROM Tb_asistencia
    WHERE id_estudiante_curso = p_id_estudiante_curso
        AND estado = 'presente'
        AND (p_fecha_inicio IS NULL OR fecha >= p_fecha_inicio)
        AND (p_fecha_fin IS NULL OR fecha <= p_fecha_fin);
    
    IF total_clases = 0 THEN
        RETURN 0;
    END IF;
    
    RETURN ROUND((clases_asistidas::NUMERIC / total_clases) * 100, 2);
END;
$$ LANGUAGE plpgsql;

-- Función: Obtener último estado de un estudiante
CREATE OR REPLACE FUNCTION obtener_ultimo_estado_estudiante(p_id_usuario INT)
RETURNS estado_est AS $$
DECLARE
    ultimo_estado estado_est;
BEGIN
    SELECT estado INTO ultimo_estado
    FROM Tb_estado_estudiante
    WHERE id_usuario = p_id_usuario
    ORDER BY fecha_actualizacion DESC
    LIMIT 1;
    
    RETURN ultimo_estado;
END;
$$ LANGUAGE plpgsql;

-- Función: Verificar si una actividad está vencida
CREATE OR REPLACE FUNCTION actividad_vencida(p_id_actividad INT)
RETURNS BOOLEAN AS $$
DECLARE
    fecha_lim TIMESTAMP;
BEGIN
    SELECT fecha_limite INTO fecha_lim
    FROM Tb_actividad
    WHERE id_actividad = p_id_actividad;
    
    IF fecha_lim IS NULL THEN
        RETURN FALSE;
    END IF;
    
    RETURN fecha_lim < CURRENT_TIMESTAMP;
END;
$$ LANGUAGE plpgsql;